---
title: Deriving type classes in Haskell is slow
---

curious about deriving performance
extracted data types from rattletrap
<https://github.com/tfausak/rattletrap>

dumped into a single module
wrote a benchmark
<https://gist.github.com/tfausak/0c90ed1b450ae84136c110f026e16bc6/399b4c7669a4ea9bb585fa1169b53ebe00f3e204>

40 records

``` haskell
data Mark = Mark
  { markValue :: String
  , markFrame :: Word
  } deriving (CLASSES)
```

4 adts

``` haskell
data RemoteId
  = PlayStationId String [Word8]
  | SplitscreenId Word32
  | SteamId Word64
  | XboxId Word64
  deriving (CLASSES)
```

10 newtypes

``` haskell
newtype UpdatedReplication = UpdatedReplication
  { updatedReplicationAttributes :: [Attribute]
  } deriving (CLASSES)
```

built with cpp via `{-# LANGUAGE CPP #-}`
using `CLASSES` to inject list of classes to derive

started with no classes on latest ghc to get a baseline

``` shell
$ ghc-8.2.1 -DCLASSES='' -fforce-recomp Deriving.hs
```

compile with all derivable classes in base
except `Bounded` and `Enum`

``` shell
$ ghc-8.2.1 -DCLASSES='Data, Eq, Ord, Read, Show, Typeable' -fforce-recomp Deriving.hs
```

compiled with ghc versions back to 7.0.1 (november 2010) for comparison

``` shell
$ ghc-7.0.1 -DCLASSES='' -fforce-recomp Deriving.hs
```

results available as raw, plain text, csv, and json
<https://github.com/tfausak/tfausak.github.io/files/1174893/report.zip>

for ghc 8.2.1
deriving all these type classes is 12 times slower than deriving none of them

Type classes            | Build time (ms)
---                     | ---
none                    | 326
`Typeable`              | 332
`Eq`                    | 597
`Show`                  | 982
`Ord` (and `Eq`)        | 1153
`Data` (and `Typeable`) | 1380
`Read`                  | 1449
all                     | 3882

![](/static/images/2017/08/09/deriving-performance.svg)

for deriving all the type classes,
ghc 8.2.1 returns us to ghc 7.8.4 levels of speed

GHC version | Build time (ms)
---         | ---
7.0.4       | 4233
7.2.2       | 4217
7.4.2       | 4090
7.6.3       | 4508
7.8.4       | 3840
7.10.3      | 4489
8.0.2       | 4643
8.2.1       | 3882

![](/static/images/2017/08/09/ghc-performance.svg)
